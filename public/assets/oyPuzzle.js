/*

	CWORD JavaScript Crossword Engine

	Copyright (C) 2007-2010 Pavel Simakov
	http://www.softwaresecretweapons.com/jspwiki/cword

	This library is free software; you can redistribute it and/or
	modify it under the terms of the GNU Lesser General Public
	License as published by the Free Software Foundation; either
	version 2.1 of the License, or (at your option) any later version.

	This library is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
	Lesser General Public License for more details.

	You should have received a copy of the GNU Lesser General Public
	License along with this library; if not, write to the Free Software
	Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA

*/
function oyCrosswordPuzzle(e,t,s,l,o,i,r,n){this.uid=oygNextRandomInt(),this.guid=e,this.appHome=t,this.ns=s,this.title=l,this.desc=o,this.w=r,this.h=n,this.clues=i,this.xpos=0,this.ypos=0,this.focused=null,this.dir=0,this.leaveGameURL=null,this.publisherURL=null,this.publisherName=null,this.canTalkToServer=!0,this.menu=null,this.canReveal=!0,this.canCheck=!0,this.reorderClues(),this.started=!1}oyCrosswordPuzzle.prototype.reorderClues=function(){for(var e=[].concat(this.clues),t=[],s=0;s<this.clues.length;s++)for(var l=0;l<this.clues.length;l++)null!=this.clues[s]&&null!=this.clues[l]&&s!=l&&this.clues[s].xpos==this.clues[l].xpos&&this.clues[s].ypos==this.clues[l].ypos&&(t.push(this.clues[s]),t.push(this.clues[l]),this.clues[s]=null,this.clues[l]=null);this.hclues=[],this.vclues=[];for(var s=0;s<t.length;s++)0==t[s].dir?this.hclues.push(t[s]):this.vclues.push(t[s]);for(var s=0;s<this.clues.length;s++)null!=this.clues[s]&&(0==this.clues[s].dir?this.hclues.push(this.clues[s]):this.vclues.push(this.clues[s]));this.clues=e},oyCrosswordPuzzle.prototype.init=function(){this.hlist=new oyClueList(this,"Across",this.hclues,"oygHClue","H"),this.vlist=new oyClueList(this,"Down",this.vclues,"oygVClue","V");var e=this;document.getElementById("oygHeader").innerHTML="<span class='oyHeaderTitle'>"+this.title+"</span><br><span class='oyHeaderDesc'>"+this.desc+"</span>";var t="<table border='0' cellspacing='0' cellpadding='0' width='100%'><tr>";t+="<td class='oyFooter' id='oygFooterStatus' align='left'></td>",t+="<td class='oyFooter' id='oygFooterClock' align='left'></td>",t+="</tr>";var s="&nbsp;";null!=this.publisherName&&(s=this.publisherName),t+="<tr><td class='oyCopyright' colspan='2' align='center'><a class='oysTextLink' id='oygCopyright' href=''>"+s+"</a></tr>",t+="</table>",document.getElementById("oygFooter").innerHTML=t,document.getElementById("oygCopyright").onclick=function(){return e.menu.leaveGameEarly(e.publisherURL),!1},this.footer=new oyCrosswordFooter(this),this.footer.stateBusy("Starting up..."),this.menu=new oyCrosswordMenu(this)},oyCrosswordPuzzle.prototype.render=function(){var e="";e+="<table border='0' cellspacing='0' cellpadding='0' style='border-collapse: collapse;'>";for(var t=0;t<this.h;t++){for(var s="<tr>",l=0;l<this.w;l++)s+="<td class='oyCellEmpty' id='oyCell"+l+"_"+t+"'></td>";e+=s+"</tr>"}e+="</table>";var o=50,i=800,r=this.w*o;i>r&&(r=i),r+="px";var n=document.getElementById("oygPuzzleFooter");n.style.width=r;var n=document.getElementById("oygState");n.style.width=r;var n=document.getElementById("oygPuzzle");n.style.width=r,n.innerHTML=e;for(var t=0;t<this.hlist.clues.length;t++)this.renderHorz(this.hlist.clues[t]);for(var t=0;t<this.vlist.clues.length;t++)this.renderVert(this.vlist.clues[t]);var n=document.getElementById("oygListH");n.innerHTML="",n.className="oyPanelDivHidden";var n=document.getElementById("oygListV");n.innerHTML="",n.className="oyPanelDivHidden"};var return_data;databaseGrab=function(e){$.ajax({dataType:"json",type:"GET",url:"/word_urls",success:function(t){return_data=t,e.puzz.bind(),e.puzz.hlist.clickItem(0),e.installContextMenu(),document.getElementById("oygStatic").innerHTML="",e.footer.stateOk("")}})},databaseRenderGrab=function(e){var t;return $.ajax({dataType:"json",type:"GET",url:"/word_urls",success:function(s){t=s,e(s)}}),t},oyCrosswordPuzzle.prototype.renderVert=function(e){databaseRenderGrab(function(t){for(var s=0;s<e.len;s++){var l="oyCell"+e.xpos+"_"+(e.ypos+s),o=document.getElementById(l);o.className="oyCellFull",o.className+=" black_and_white",o.style.backgroundImage="url("+t[Math.floor(40*Math.random()+1)].photos[Math.floor(4*Math.random()+1)]+")",o.style.backgroundSize="46px 46px"}})},oyCrosswordPuzzle.prototype.renderHorz=function(e){databaseRenderGrab(function(t){for(var s=0;s<e.len;s++){var l="oyCell"+(e.xpos+s)+"_"+e.ypos,o=document.getElementById(l);o.className="oyCellFull",o.className+=" black_and_white",o.style.backgroundImage="url("+t[Math.floor(40*Math.random()+1)].photos[Math.floor(4*Math.random()+1)]+")",o.style.backgroundSize="46px 46px"}})},oyCrosswordPuzzle.prototype.fillVert=function(e,t){for(var s=0;s<return_data.length;s++)if(return_data[s].word==e.answer)for(var l=0;l<e.len;l++){var o="oyCell"+e.xpos+"_"+(e.ypos+l),i=document.getElementById(o);i.className+=" oy-cell-cool",i.classList.remove("black_and_white"),this.fillIn(i,e,e.xpos,e.ypos+l,l,s,t,1),this.menu.setCellState(e.xpos,e.ypos+l,0)}},oyCrosswordPuzzle.prototype.fillHorz=function(e,t){for(var s=0;s<return_data.length;s++)if(return_data[s].word==e.answer)for(var l=0;l<e.len;l++){var o="oyCell"+(e.xpos+l)+"_"+e.ypos,i=document.getElementById(o);i.className+=" oy-cell-cool",i.classList.remove("black_and_white"),this.fillIn(i,e,e.xpos+l,e.ypos,l,s,t,0),this.menu.setCellState(e.xpos+l,e.ypos,0)}},oyCrosswordPuzzle.prototype.fillIn=function(e,t,s,l,o,i){e.style.backgroundImage="url("+return_data[i].photos[o]+")",e.style.backgroundSize="46px 46px",e.className+=" oy-cell-cool",e.innerHTML="<input id='oyInput"+s+"_"+l+"' class='oyCellInput' autocomplete='off' type='text' size='1' maxlength='1' value=''>"},oyCrosswordPuzzle.prototype.bind=function(){var e=document.getElementById("oygListH");e.className="oyPanelDiv",e.innerHTML=this.hlist.render();var e=document.getElementById("oygListV");e.className="oyPanelDiv",e.innerHTML=this.vlist.render();for(var t=0,s=0;s<this.hlist.clues.length;s++)this.fillHorz(this.hlist.clues[s],t),t++;for(var l=0,s=0;s<this.vlist.clues.length;s++)this.fillVert(this.vlist.clues[s],l),l++;this.inputCache=new oyGridElementCache(this.w,this.h,"oyInput");for(var s=0;s<this.h;s++)for(var o=0;o<this.w;o++)this.bindItem(o,s);this.menu.bind(),this.footer.bind(),this.hlist.bind(),this.vlist.bind(),this.footer.update(),this.started=!0},oyCrosswordPuzzle.prototype.unbind=function(){for(var e=0;e<this.h;e++)for(var t=0;t<this.w;t++){var s=this.inputCache.getElement(t,e);null!=s&&(s.onclick=null,s.onkeydown=null,s.onchange=null)}this.hlist.unbind(),this.vlist.unbind(),this.footer.unbind(),this.menu.unbind()},oyCrosswordPuzzle.prototype.bindItem=function(e,t){var s=this.inputCache.getElement(e,t);if(null!=s){var l=this;s.onclick=function(){l.unfocusOldCell(),l.focusNewCell(e,t,!1)},s.onkeydown=function(s){return l.handleKeyDown(e,t,s)},s.onkeypress=function(s){return l.handleKeyPress(e,t,s)}}},oyCrosswordPuzzle.prototype.focusLists=function(e,t){var s=this.hlist.getClueIndexForPoint(e,t);this.hlist.selectItem(s);var l=this.vlist.getClueIndexForPoint(e,t);this.vlist.selectItem(l)},oyCrosswordPuzzle.prototype.focusCellList=function(e,t){for(var s=0;s<e.length;s++){var l=document.getElementById("oyCell"+e[s].x+"_"+e[s].y),o=this.menu.getCellState(e[s].x,e[s].y);null!=l&&(t&&0==o?l.className="oyCellFocused":this.restoreCellState(l,e[s].x,e[s].y))}},oyCrosswordPuzzle.prototype.unfocusOldWord=function(){null!=this.focused&&(this.focusCellList(this.menu.getCellPosListFor(this.focused),!1),this.focused=null)},oyCrosswordPuzzle.prototype.focusNewWord=function(e,t){var s=this.hlist.getClueIndexForPoint(e,t),l=this.vlist.getClueIndexForPoint(e,t),o=null;return-1!=s&&-1!=l?o=0==this.dir?this.hlist.clues[s]:this.vlist.clues[l]:(-1!=s&&(o=this.hlist.clues[s]),-1!=l&&(o=this.vlist.clues[l])),o},oyCrosswordPuzzle.prototype.focusNewCell=function(e,t,s,l){this.focused=null!=l?l:this.focusNewWord(e,t),null!=this.focused&&(this.dir=this.focused.dir,this.focusCellList(this.menu.getCellPosListFor(this.focused),!0));var o=document.getElementById("oyCell"+e+"_"+t);if(null!=o&&(o.className="oyCellActive",this.focusLists(e,t),s)){var o=this.inputCache.getElement(e,t);o.focus()}this.xpos=e,this.ypos=t,this.menu.focusNewCell(e,t),this.menu.invalidateMenu()},oyCrosswordPuzzle.prototype.unfocusOldCell=function(){var e=document.getElementById("oyCell"+this.xpos+"_"+this.ypos);null!=e&&this.restoreCellState(e,this.xpos,this.ypos),this.unfocusOldWord()},oyCrosswordPuzzle.prototype.invalidate=function(){this.unfocusOldCell(),this.focusNewCell(this.xpos,this.ypos,!0)},oyCrosswordPuzzle.prototype.restoreCellState=function(e,t,s){var l=this.menu.getCellState(t,s);switch(l){case-1:e.className="oyCellEmpty";break;case 0:e.className="oyCellFull";break;case 1:e.className="oyCellGuessed";break;case 2:e.className="oyCellRevealed";break;default:alert("Bad state code!")}},oyCrosswordPuzzle.prototype.isValidChar=function(e){return e>="A"&&"Z">=e||" "==e},oyCrosswordPuzzle.prototype.moveToPrevCell=function(e,t){0==this.dir?e--:t--;var s=this.menu.getCellState(e,t);if(-1!=s){var l=this.inputCache.getElement(e,t);null!=l&&(this.unfocusOldCell(),this.focusNewCell(e,t,!1),l.focus())}},oyCrosswordPuzzle.prototype.moveToNextCell=function(e,t){0==this.dir?e++:t++;var s=this.menu.getCellState(e,t);if(-1!=s){var l=this.inputCache.getElement(e,t);null!=l&&(this.unfocusOldCell(),this.focusNewCell(e,t,!1),l.focus())}},oyCrosswordPuzzle.prototype.handleKeyPress=function(e,t,s){s||(s=window.event);var l=s.which?s.which:s.keyCode,o=String.fromCharCode(l).toUpperCase();if(32==l&&(o=" "),this.isValidChar(o)){var i=this.inputCache.getElement(e,t);i.readOnly||(i.value=o.toUpperCase()),this.moveToNextCell(e,t)}return!1},oyCrosswordPuzzle.prototype.handleKeyDown=function(e,t,s){s||(s=window.event);var l=s.which?s.which:s.keyCode,o=l>=37&&40>=l||8==l;if(o){var i=null;switch(l){case 8:this.moveToPrevCell(e,t);break;case 37:for(;;){if(!(e>0))break;if(e-=1,i=this.inputCache.getElement(e,t),null!=i)break}break;case 39:for(;;){if(!(e<this.w-1))break;if(e+=1,i=this.inputCache.getElement(e,t),null!=i)break}break;case 38:for(;;){if(!(t>0))break;if(t-=1,i=this.inputCache.getElement(e,t),null!=i)break}break;case 40:for(;;){if(!(t<this.h-1))break;if(t+=1,i=this.inputCache.getElement(e,t),null!=i)break}}null!=i&&(this.unfocusOldCell(),this.focusNewCell(e,t,!1),i.focus())}return!0};