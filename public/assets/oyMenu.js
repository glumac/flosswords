/*

	CWORD JavaScript Crossword Engine

	Copyright (C) 2007-2010 Pavel Simakov
	http://www.softwaresecretweapons.com/jspwiki/cword

	This library is free software; you can redistribute it and/or
	modify it under the terms of the GNU Lesser General Public
	License as published by the Free Software Foundation; either
	version 2.1 of the License, or (at your option) any later version.

	This library is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
	Lesser General Public License for more details.

	You should have received a copy of the GNU Lesser General Public
	License along with this library; if not, write to the Free Software
	Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA

*/
function oyCrosswordMenu(e){this.puzz=e,this.hlist=e.hlist,this.vlist=e.vlist,this.footer=e.footer,this.canReveal=e.canReveal,this.canCheck=e.canCheck,this.clues=e.clues,this.currentMenu=null,this.over=null,this.cache=new Array;for(var t=0;t<this.puzz.h;t++)for(var s=0;s<this.puzz.w;s++){var o=s+"_"+t;this.cache[o]=-1}this.checks=0,this.reveals=0,this.deducts=0,this.matches=0,this.score=0,this.rank=-1,this.xpos=e.xpos,this.ypos=e.ypos,this.name=oyGetCookie("OYG_NICK_NAME"),(null==this.name||""==this.name)&&(this.name="Click"),this.server=new oyServer(this.puzz.appHome,this.puzz.ns,this.puzz.canTalkToServer),this.scoreSubmittedMatches=0}var dispName;oyCrosswordMenu.prototype.setCellState=function(e,t,s){this.cache[e+"_"+t]=s},oyCrosswordMenu.prototype.getCellState=function(e,t){return this.cache[e+"_"+t]},oyCrosswordMenu.prototype.bind=function(){this.inputCache=this.puzz.inputCache,this.startOn=new Date},oyCrosswordMenu.prototype.unbind=function(){this.inputCache=null},oyCrosswordMenu.prototype.focusNewCell=function(e,t){this.xpos=e,this.ypos=t},oyCrosswordMenu.prototype.invalidateMenu=function(){null!=this.currentMenu&&this.currentMenu()},oyCrosswordMenu.prototype.installWelcomeMenu=function(){this.currentMenu=this.installWelcomeMenu;var e=document.getElementById("oygPuzzleFooter");e.innerHTML="";var t=this;dispName=escape(this.name),dispName=dispName.replace(/%20/g," "),this.addNoneWordAction(e,"Welcome, <a class='oysTextLink' href='' id='oygWelcomeLink'>"+dispName+"</a>! ");var s=document.getElementById("oygWelcomeLink");s.onclick=function(){return t.askNickName(),t.invalidateMenu(),!1},this.addNewLine(e),this.addAction(e,"Start Now","Starting...","strt",function(){databaseGrab(t)}),this.footer.stateOk(""),this.server.trackAction(this.puzz.uid,"wlm")},oyCrosswordMenu.prototype.installContextMenu=function(){this.currentMenu=this.installContextMenu;var e=document.getElementById("oygPuzzleFooter");e.innerHTML="";var t=this.hlist.getClueIndexForPoint(this.xpos,this.ypos),s=this.vlist.getClueIndexForPoint(this.xpos,this.ypos);if(this.canReveal){if(-1!=t){var o="Reveal Across</b>";this.hlist.clues[t].completed()?this.addAction(e,o,"",null,null):this.addRevealWordAction(this.hlist.clues[t],e,o)}if(-1!=s){var o="Reveal Down</b>";this.vlist.clues[s].completed()?this.addAction(e,o,"",null,null):this.addRevealWordAction(this.vlist.clues[s],e,o)}}else this.addNoneWordAction(e,"Reveal Disabled");if(this.canCheck){var o="Check Across</b>";-1!=t&&(this.hlist.clues[t].completed()?this.addAction(e,o,"",null,null):this.addCheckWordAction(this.hlist.clues[t],e,o));var o="Check Down</b>";-1!=s&&(this.vlist.clues[s].completed()?this.addAction(e,o,"",null,null):this.addCheckWordAction(this.vlist.clues[s],e,o));var i=this;this.addAction(e,"Check <b>All</b>","Checking All...","chkll",function(){return i.checkAll(),i.invalidateMenu(),!1}),this.addNewLine(e);var i=this;this.addSubmitLeaveMenuItems(e)}else this.addNoneWordAction(e,"Check Disabled");this.footer.update();for(var n=!1,r=0;r<this.clues.length;r++)if(!this.clues[r].completed()){n=!0;break}n||(this.over=!0),this.over&&(this.over=!0,this.puzz.unbind(),this.installDoneMenu())},oyCrosswordMenu.prototype.installDoneMenu=function(){this.currentMenu=this.installDoneMenu;var e=document.getElementById("oygPuzzleFooter");e.innerHTML="",this.addNoneWordAction(e,"Game Over!"),this.addNewLine(e);var t="<b id='player_name'>"+dispName+"</b>"+", you scored <b id='player_score'>"+this.score+"</b> points!";-1!=this.rank&&(t+=" (rank <b>"+this.rank+"</b>)"),t+=".",$.ajax({url:"/scores",dataType:"json",type:"POST",data:{score:{game_score:this.score,user_name:dispName}},complete:function(){}}),this.addNoneWordAction(e,t),this.addNewLine(e),this.addSubmitLeaveMenuItems(e),this.footer.stateOk("Game over!"),this.server.trackAction(this.puzz.uid,"ovr"),this.footer.update()},oyCrosswordMenu.prototype.addSubmitLeaveMenuItems=function(e){if(this.puzz.canTalkToServer){var t="Submit <b>Score</b>";if(this.matches>0&&this.scoreSubmittedMatches<this.matches){var s=this;this.addAction(e,t,"Submitting score...","sbmt",function(){return s.submitScore(),s.invalidateMenu(),!1})}else this.addAction(e,t,"",null,null)}var s=this;this.addAction(e,"Leave <b>Game</b>","Leaving...","lv",function(){return s.leaveGameEarly(s.puzz.leaveGameURL),s.footer.stateOk("Done"),!1})},oyCrosswordMenu.prototype.leaveGameEarly=function(){this.footer.stateBusy("Leaving...");var e=!0;this.puzz.started&&!this.over&&(e=confirm("Do you want to start a new Flosswords game?")),e&&(window.location="/"),this.footer.stateOk("Done")},oyCrosswordMenu.prototype.addAction=function(e,t,s,o,i){t=t.replace(" ","&nbsp;");var n=document.createElement("SPAN");n.innerHTML=" &nbsp; ",e.appendChild(n);var n=document.createElement("A");if(n.innerHTML=t,n.href="",i){n.className="oyMenuAction";var r=this;n.onclick=function(){return r.footer.stateBusy(s),setTimeout(function(){i(),r.server.trackAction(r.puzz.uid,o)},100),!1}}else n.className="oyMenuActionDis",n.onclick=function(){return!1};e.appendChild(n)},oyCrosswordMenu.prototype.addNewLine=function(e){var t=document.createElement("SPAN");t.innerHTML="<span style='font-size: 4px;'><br />&nbsp;<br /></span>",e.appendChild(t)},oyCrosswordMenu.prototype.addNoneWordAction=function(e,t){var s=document.createElement("SPAN");s.className="oyMenuActionNone",s.innerHTML=t,e.appendChild(s);var s=document.createElement("SPAN");s.innerHTML=" ",e.appendChild(s)},oyCrosswordMenu.prototype.addCheckWordAction=function(e,t,s){var o=this;this.addAction(t,s,"Checking...","chk",function(){return o.checkWord(e),o.invalidateMenu(),!1})},oyCrosswordMenu.prototype.addRevealWordAction=function(e,t,s){var o=this;this.addAction(t,s,"Revealing...","rvl",function(){return o.revealWord(e),o.invalidateMenu(),!1})},oyCrosswordMenu.prototype.getCurrentValueFor=function(e,t){var s=this.inputCache.getElement(e,t).value;return(" "==s||""==s)&&(s=null),s},oyCrosswordMenu.prototype.getCellPosListFor=function(e){for(var t=new Array,s=0;s<e.len;s++)t.push(this.charToPos(e,s));return t},oyCrosswordMenu.prototype.charToPos=function(e,t){var s=new function(){};return 0==e.dir?(s.x=e.xpos+t,s.y=e.ypos):(s.x=e.xpos,s.y=e.ypos+t),s},oyCrosswordMenu.prototype.showAnswer=function(e,t){for(var s=0;s<e.len;s++){var o=this.charToPos(e,s),i=this.inputCache.getElement(o.x,o.y);if(!i.readOnly){i.readOnly=!0,i.value=e.answer.charAt(s).toUpperCase(),this.setCellState(o.x,o.y,t);var n=document.getElementById("oyCell"+o.x+"_"+o.y);switch(t){case 1:n.className="oyCellGuessed";break;case 2:n.className="oyCellRevealed";break;default:alert("Bad state code!")}}}this.puzz.invalidate()},oyCrosswordMenu.prototype.checkWordStatus=function(e){var t=new function(){};t.wrong=0,t.isComplete=!0,t.buf="";for(var s=0;s<e.len;s++){var o;o=0==e.dir?this.getCurrentValueFor(e.xpos+s,e.ypos):this.getCurrentValueFor(e.xpos,e.ypos+s),null==o?(t.isComplete=!1,t.buf+="."):t.buf+=o,o!=e.answer.charAt(s).toUpperCase()&&t.wrong++}return t},oyCrosswordMenu.prototype.askNickName=function(e){e=e?"Score: "+e+". ":"",null==this.name&&(this.name="");var t=this.name;this.name=window.prompt(e+"Enter your initials.",this.name.substring(0,3).toUpperCase());var s=!0;return(null==this.name||""==this.name)&&(this.name=t.substring(0,3).toUpperCase(),s=!1),null!=this.name&&""!=this.name?(oySetCookieForPeriod("OYG_NICK_NAME",this.name.substring(0,3).toUpperCase(),31104e6,"/"),s.substring(0,3).toUpperCase()):(this.name="Enter initials",!1)},oyCrosswordMenu.prototype.getScoreForMatch=function(e){return e.len},oyCrosswordMenu.prototype.getDeductsForReveal=function(e){return 2*e.len},oyCrosswordMenu.prototype.getDeductionForCheck=function(e){var t=3,s=(e.len-e.len%t)/t;return 1>s&&(s=1),s},oyCrosswordMenu.prototype.revealWord=function(e){this.deducts+=this.getDeductsForReveal(e),this.reveals++,this.showAnswer(e,2),e.revealed=!0,e.matched=!1;var t=this.checkWordStatus(e);this.footer.stateOk("Revealed ["+t.buf+"]!")},oyCrosswordMenu.prototype.checkAll=function(){for(var e=0,t=0,s=0;s<this.clues.length;s++)if(!this.clues[s].completed()){var o=this.checkWordStatus(this.clues[s]);o.isComplete&&(e++,this.checks++,this.deducts+=this.getDeductionForCheck(this.clues[s]),0==o.wrong&&(this.showAnswer(this.clues[s],1),this.score+=this.getScoreForMatch(this.clues[s]),this.clues[s].matched=!0,this.clues[s].revealed=!1,t++,this.matches++))}0==e?this.footer.stateError("No complete words found!"):this.footer.stateOk("Checked "+e+", "+t+" matched!")},oyCrosswordMenu.prototype.checkWord=function(e){var t=this.checkWordStatus(e);t.isComplete?(this.checks++,this.deducts+=this.getDeductionForCheck(e),0!=t.wrong?(this.footer.stateError("["+t.buf+"] didn't match!"),setTimeout('$("#oygState").empty()',3e3)):(this.matches++,this.showAnswer(e,1),this.score+=this.getScoreForMatch(e),e.revealed=!1,e.matched=!0,this.footer.stateError("["+t.buf+"] matched!"),setTimeout('$("#oygState").empty()',3e3))):(this.footer.stateError("The word ["+t.buf+"] is incomplete!"),setTimeout('$("#oygState").empty()',3e3))},oyCrosswordMenu.prototype.submitScore=function(){if(0==this.matches)this.footer.stateError("Nothing to submit yet!"),alert("Nothing to submit yet!\nUncover some words first.");else{var e=(new Date).getTime()-this.puzz.menu.startOn.getTime();this.server.submitScore(this,this.puzz.uid,this.score,this.deducts,this.checks,this.reveals,this.matches,e,this.name,this.puzz.clues),this.footer.stateBusy("Submitting score...")}};